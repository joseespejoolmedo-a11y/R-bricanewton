<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Pizarra PRO â€” Apple Pencil + Lazo + CaligrafÃ­a</title>
<style>
/* --- TEMA OSCURO (POR DEFECTO) --- */
:root {
  --bg: #0f1317;
  --panel: #151a20;
  --line: #2a3340;
  --text: #e9eef4;
  --muted: #a7b2be;
  --accent: #6aa9ff;
  --board-bg: #0b0f13;
  --grid-color: rgba(255, 255, 255, 0.08);
}
/* --- TEMA CLARO --- */
[data-theme="light"] {
  --bg: #f8f9fa;
  --panel: #ffffff;
  --line: #dee2e6;
  --text: #212529;
  --muted: #6c757d;
  --accent: #0d6efd;
  --board-bg: #ffffff;
  --grid-color: rgba(0, 0, 0, 0.08);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{height:100%}
body{
  margin:0; height:100%; color:var(--text); background: var(--bg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  -webkit-user-select:none;user-select:none;-webkit-touch-callout:none;
  overscroll-behavior:none; display:flex; flex-direction:column;
  transition: background .2s ease, color .2s ease;
}
input,select,textarea,button,label{ -webkit-user-select:auto; user-select:auto; }
#toolbar{
  z-index:1000;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;
  background:var(--panel); border-bottom:1px solid var(--line);padding:.5rem;flex-shrink:0;
}
.group{display:flex;gap:.35rem;align-items:center;background:var(--bg);border:1px solid var(--line);border-radius:.6rem;padding:.35rem .45rem}
.btn{background:var(--panel);border:1px solid var(--line);color:var(--text);padding:.45rem .6rem;border-radius:.55rem;cursor:pointer;font-weight:600}
.btn.active{outline:2px solid var(--accent)}
.btn.toggle.on{outline:2px solid var(--accent)}
.btn.danger{background:#3a1f1f;border-color:#6a2a2a; color:#ffc1c1;}
[data-theme="light"] .btn.danger { background:#fdf0f0;border-color:#f5c2c7;color:#861828; }
label{font-size:.9rem;color:var(--muted);display:flex;align-items:center;gap:.35rem}
input[type=range]{width:120px}
#colors .sw{width:26px;height:26px;border-radius:50%;border:2px solid #0008;cursor:pointer;box-shadow:0 0 0 2px #0005 inset}
#board{display:block;background:var(--board-bg);touch-action:none;flex-grow:1;height:auto;width:100%}
#hint{position:fixed;right:.75rem;bottom:.75rem;background:#0009;color:#fff;padding:.35rem .55rem;border-radius:.55rem;font-size:.85rem;pointer-events:none;z-index:2}
#toast{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:#1f2a33;color:#fff;border:1px solid #2f3b46;border-radius:.6rem;padding:.35rem .6rem;font-size:.85rem;display:none;z-index:4}
select{background:var(--panel);color:var(--text);border:1px solid var(--line);border-radius:.45rem;padding:.35rem .45rem}
#selMenu{position:fixed;z-index:1200;display:none;gap:.35rem;background:var(--panel);border:1px solid var(--line);border-radius:.6rem;padding:.35rem .45rem;box-shadow:0 6px 18px #0008}
</style>
</head>
<body>

<div id="toolbar">
  <div class="group">
    <button class="btn" data-tool="pen">âœï¸ LÃ¡piz</button>
    <button class="btn" data-tool="eraser">ğŸ§½ Goma</button>
    <label>Grosor <input id="penSize" type="range" min="1" max="40" value="6"></label>
    <label>Goma <input id="eraserSize" type="range" min="6" max="80" value="22"></label>
    <label>Texto <input id="textSize" type="range" min="12" max="80" value="28"></label>
  </div>

  <div class="group" id="colors"></div>

  <div class="group">
    <span>Figuras:</span>
    <button class="btn" data-tool="line">ï¼</button>
    <button class="btn" data-tool="arrow">â¤</button>
    <button class="btn" data-tool="rect">â–­</button>
    <button class="btn" data-tool="ellipse">â—¯</button>
    <button class="btn" data-tool="triangle">â–³</button>
    <button class="btn" data-tool="text">T</button>
    <button class="btn" data-tool="star">â­</button>
    <button class="btn" data-tool="hexagon">â¬¢</button>
    <button class="btn" data-tool="rhombus">â¬§</button>
  </div>

  <div class="group">
    <button class="btn" data-tool="highlight">â­• CÃ­rculo</button>
    <button class="btn" data-tool="lasso">ğŸª¢ Lazo</button>
    <button class="btn" id="pasteBtn">ğŸ“Œ Pegar</button>
  </div>

  <div class="group">
    <button class="btn" id="undo">â†¶</button>
    <button class="btn" id="redo">â†·</button>
    <button class="btn danger" id="clear">ğŸ—‘ï¸ Limpiar</button>
  </div>

  <div class="group">
    <button class="btn" id="save">ğŸ–¼ï¸ PNG</button>
    <button class="btn" id="share">ğŸ”— Compartir</button>
    <button class="btn" id="imgFileBtn">ğŸ–¼ï¸ Archivo</button>
    <button class="btn" id="imgUrlBtn">ğŸ”— URL imagen</button>
    <input id="imgFile" type="file" accept="image/*" hidden>
  </div>

  <div class="group">
    <select id="pageSelect" title="PÃ¡gina"></select>
    <button class="btn" id="pageAdd">ï¼‹</button>
    <button class="btn" id="pageDup">â§‰</button>
    <button class="btn danger" id="pageDel">ğŸ—‘ï¸</button>
  </div>

  <div class="group">
    <button class="btn" id="saveWB" title="Guardar proyecto (.whiteboard)">WB</button>
    <button class="btn" id="loadWB" title="Cargar .whiteboard">ğŸ“‚</button>
    <input id="wbFile" type="file" accept=".whiteboard,application/json" hidden>
  </div>

  <div class="group">
    <button class="btn" id="resetView">ğŸ” 100%</button>
    <button class="btn" id="themeToggle">â˜€ï¸ Tema</button>
  </div>

  <!-- âœ¨ NUEVO: CaligrafÃ­a para dedo -->
  <div class="group">
    <button class="btn toggle" id="calliToggle">ğ’ CaligrafÃ­a: OFF</button>
    <label>Estilo
      <select id="calliStyle">
        <option value="academica">AcadÃ©mica</option>
        <option value="romantica">RomÃ¡ntica</option>
      </select>
    </label>
  </div>

  <!-- âœ¨ NUEVO: Pantalla completa -->
  <div class="group">
    <button class="btn" id="fsToggle" title="Pantalla completa">â›¶ Pantalla completa</button>
  </div>
</div>

<canvas id="board" draggable="false"></canvas>
<div id="hint">âœï¸ Dibuja Â· ğŸ§½ Borra Â· Pinza para <b>zoom</b> y <b>mover</b> Â· T para texto Â· ğŸª¢ Lazo libre Â· ğ’ CaligrafÃ­a con <b>dedo</b></div>
<div id="toast"></div>

<div id="selMenu">
  <button class="btn" id="selCopy">ğŸ“‹ Copiar</button>
  <button class="btn" id="selCut">âœ‚ï¸ Cortar</button>
  <button class="btn" id="selCancel">âœ– Cancelar</button>
</div>

<script>
(() => {
  // ---------- util ----------
  const $ = s => document.querySelector(s);
  const toastEl = $('#toast');
  const toast = t => { toastEl.textContent=t; toastEl.style.display='block'; clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.style.display='none',1200); };

  // ---------- canvas / cÃ¡mara ----------
  const cv = document.getElementById('board');
  const ctx = cv.getContext('2d', {alpha:true, desynchronized:true});
  let dpr = Math.max(1, window.devicePixelRatio||1);
  let cam = {x:0,y:0,s:1};
  const minS=0.25, maxS=8;
  let drawNow=false;

  cv.style.touchAction = 'none';

  function fit(){
    const w=cv.clientWidth, h=cv.clientHeight;
    dpr=Math.max(1,window.devicePixelRatio||1);
    cv.width=Math.round(w*dpr); cv.height=Math.round(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    drawNow=true;
  }
  new ResizeObserver(fit).observe(cv); fit();

  const resetViewBtn = $('#resetView');
  const updateZoomIndicator = () => resetViewBtn.textContent = `ğŸ” ${Math.round(cam.s * 100)}%`;

  const toWorld=(px,py)=>{ const r=cv.getBoundingClientRect(); return {x:(px-r.width/2)/cam.s-cam.x, y:(py-r.height/2)/cam.s-cam.y}; };
  const worldToScreen=(wx,wy)=>{ const r=cv.getBoundingClientRect(); return {sx:(wx+cam.x)*cam.s + r.width/2, sy:(wy+cam.y)*cam.s + r.height/2}; };
  const applyCam=()=>{ const r=cv.getBoundingClientRect(); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.translate(r.width/2, r.height/2); ctx.scale(cam.s, cam.s); ctx.translate(cam.x, cam.y); };
  resetViewBtn.onclick=()=>{ cam={x:0,y:0,s:1}; drawNow=true; updateZoomIndicator(); toast('Vista 100%'); };

  // ---------- herramientas ----------
  const colors=['#ffffff','#ff3b30','#34c759','#0a84ff','#ffd60a','#ff9f0a','#a55eea','#50c8ff','#ff6b6b','#a7b2be'];
  const colorsWrap = $('#colors');
  colors.forEach(c=>{ const d=document.createElement('div'); d.className='sw'; d.style.background=c; d.onclick=()=>{ tool.color=c; setTool('pen'); }; colorsWrap.appendChild(d); });

  const toolBtns=[...document.querySelectorAll('[data-tool]')];
  const selMenu = $('#selMenu');
  function hideSelMenu(){ selMenu.style.display='none'; }
  function highlight(t){ toolBtns.forEach(b=>b.classList.toggle('active', b.dataset.tool===t)); }
  function setTool(t){ tool.mode=t; highlight(t); hideSelMenu(); }

  // âœ¨ estado general + caligrafÃ­a
  const tool={
    mode:'pen', color:'#ffffff', penSize:6, eraserSize:22, textSize:28,
    calliOn:false, calliStyle:'academica'
  };

  $('#penSize').oninput=e=> tool.penSize=+e.target.value;
  $('#eraserSize').oninput=e=> tool.eraserSize=+e.target.value;
  $('#textSize').oninput=e=> tool.textSize=+e.target.value;
  toolBtns.forEach(b=> b.onclick=()=> setTool(b.dataset.tool) );
  setTool('pen');

  // CaligrafÃ­a UI
  const calliToggle = $('#calliToggle');
  const calliStyleSel = $('#calliStyle');
  function updateCalliUI(){
    calliToggle.textContent = tool.calliOn ? 'ğ’ CaligrafÃ­a: ON' : 'ğ’ CaligrafÃ­a: OFF';
    calliToggle.classList.toggle('on', tool.calliOn);
  }
  calliToggle.onclick = ()=>{ tool.calliOn = !tool.calliOn; updateCalliUI(); toast('CaligrafÃ­a ' + (tool.calliOn?'activada':'desactivada')); };
  calliStyleSel.onchange = e=>{ tool.calliStyle = e.target.value; toast('Estilo: ' + (tool.calliStyle==='academica'?'AcadÃ©mica':'RomÃ¡ntica')); };

  // ---------- pÃ¡ginas / historial ----------
  let pages=[]; let activePage=0;
  const makePage=(name='PÃ¡gina '+(pages.length+1))=>({name,camera:{...cam},objects:[]});
  function ensurePages(){ if(!pages.length){ pages=[makePage('PÃ¡gina 1')]; activePage=0; refreshPages(); } }
  function refreshPages(){ const sel=$('#pageSelect'); sel.innerHTML=''; pages.forEach((p,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=p.name; if(i===activePage) o.selected=true; sel.appendChild(o); }); drawNow=true; }
  function saveCam(){ if(pages[activePage]) pages[activePage].camera={...cam}; }
  $('#pageSelect').onchange=e=>{ saveCam(); activePage=+e.target.value; cam={...pages[activePage].camera}; updateZoomIndicator(); drawNow=true; };
  $('#pageAdd').onclick=()=>{ saveCam(); pages.push(makePage()); activePage=pages.length-1; refreshPages(); commit(); toast('PÃ¡gina creada'); };
  $('#pageDup').onclick=()=>{ saveCam(); const c=JSON.parse(JSON.stringify(pages[activePage])); c.name+=' (copia)'; pages.splice(activePage+1,0,c); activePage++; refreshPages(); commit(); toast('PÃ¡gina duplicada'); };
  $('#pageDel').onclick=()=>{ if(pages.length<=1) return alert('Debe quedar al menos una.'); if(!confirm('Â¿Eliminar esta pÃ¡gina?')) return; pages.splice(activePage,1); activePage=Math.max(0,activePage-1); cam={...pages[activePage].camera}; refreshPages(); commit(); toast('PÃ¡gina eliminada'); };
  ensurePages();
  const objs=()=>pages[activePage]?.objects || [];

  let undoStack=[], redoStack=[];
  const snap=()=>JSON.stringify({ cam, pages: pages.map(p=>({name:p.name,camera:p.camera,objects:p.objects.map(o=>o.type==='image'? {...o,img:undefined}:o)})) , activePage});
  const commit=()=>{ redoStack.length=0; undoStack.push(snap()); if(undoStack.length>80) undoStack.shift(); saveCam(); };
  const restore = async (txt) => {
    const s = JSON.parse(txt);
    cam = s.cam; pages = s.pages; activePage = s.activePage || 0;
    const promises=[];
    for (const p of pages) for (const o of p.objects) if(o.type==='image' && o.src){
      promises.push(new Promise((res,rej)=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{o.img=img; res();}; img.onerror=rej; img.src=o.src; }));
    }
    try{ await Promise.all(promises);}catch(e){ console.warn('Carga imagen',e); }
    updateZoomIndicator(); refreshPages(); drawNow=true;
  };
  $('#undo').onclick=async()=>{ if(!undoStack.length) return; redoStack.push(snap()); await restore(undoStack.pop()); toast('â†¶'); };
  $('#redo').onclick=async()=>{ if(!redoStack.length) return; undoStack.push(snap()); await restore(redoStack.pop()); toast('â†·'); };

  // ---------- interacciÃ³n ----------
  const pointers=new Map();
  let drawing=null, pinch=null, preview=null, downInfo=null;
  let lastStroke=null;
  const JOIN_DIST_FACTOR=0.9, JOIN_TIME_MS=160;

  // ---------- helpers de caligrafÃ­a ----------
  function calliParams(style){
    if(style==='romantica'){
      return { nibAngle: Math.PI/4, contrast: 0.85, taperPts: 10, smoothStep: 2.2, fingerScale: 0.60 };
    } else { // acadÃ©mica
      return { nibAngle: Math.PI*0.95/3, contrast: 0.65, taperPts: 8, smoothStep: 2.5, fingerScale: 0.70 };
    }
  }

  function movingAverageSmooth(pts, win=3){
    if(pts.length<=2) return pts.slice();
    const out=[];
    for(let i=0;i<pts.length;i++){
      let sx=0, sy=0, n=0;
      for(let k=-win;k<=win;k++){
        const j=Math.min(pts.length-1, Math.max(0, i+k));
        sx+=pts[j].x; sy+=pts[j].y; n++;
      }
      out.push({x:sx/n, y:sy/n, pr:pts[i].pr, t:pts[i].t});
    }
    return out;
  }

  function resampleUniform(pts, step){
    if(pts.length<2) return pts.slice();
    const out=[pts[0]];
    for(let i=1;i<pts.length;i++){
      const a=out[out.length-1], b=pts[i];
      let dx=b.x-a.x, dy=b.y-a.y, dist=Math.hypot(dx,dy);
      while(dist>=step){
        const t=step/dist;
        const nx=a.x+dx*t, ny=a.y+dy*t;
        out.push({x:nx, y:ny, pr:b.pr, t:b.t});
        dx=b.x-nx; dy=b.y-ny; dist=Math.hypot(dx,dy);
      }
    }
    out.push(pts[pts.length-1]);
    return out;
  }

  // ---------- helpers de dibujo ----------
  const makeStroke=(erase=false)=>({type:'stroke',color:tool.color,size: erase?tool.eraserSize:tool.penSize, erase, pts:[], _lastRenderedIdx: 0, calli:false, nibAngle:0, contrast:0.7, taperPts:8 });
  const addPt=(st,p)=>{ const last=st.pts[st.pts.length-1]; const t=performance.now(); const dt=last?Math.max(1,t-last.t):1; const v=last?Math.hypot(p.x-last.x,p.y-last.y)/dt:0; 
    const a= last ? Math.atan2(p.y-LAST.y, p.x-LAST.x) : 0;
    st.pts.push({x:p.x,y:p.y,t,pr:p.pr||0.5,v,a});
  };

  function strokeW(st, pt, i, len){
    if(st.erase) return st.size;
    const base = (pt.pr>0) ? (0.35 + pt.pr*0.9) : (1.10/(1+4*(pt.v||0)));
    let w = st.size * base;
    if(st.calli){
      const ang = (pt.a!=null)? pt.a : 0;
      const mod = 0.55 + st.contrast * Math.abs(Math.sin(ang - st.nibAngle));
      w *= mod;
    }
    const T = st.taperPts || 8;
    if(len> T*2){
      if(i < T){ const t = i/(T-1); w *= (t*t*(3-2*t)); }
      else if(i > len-T){ const t = (len-1-i)/(T-1); w *= (t*t*(3-2*t)); }
    }
    return Math.max(0.8, Math.min(st.size*1.6, w));
  }

  function drawStroke(st) {
    const pts = st.pts;
    if (!pts.length) return;
    ctx.save();
    ctx.globalCompositeOperation = st.erase ? 'destination-out' : 'source-over';
    ctx.strokeStyle = st.erase ? '#000' : st.color;
    ctx.fillStyle = st.erase ? '#000' : st.color;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    if (pts.length === 1) {
      const p = pts[0]; const w = strokeW(st, p, 0, 1);
      ctx.beginPath(); ctx.arc(p.x, p.y, w / 2, 0, Math.PI * 2); ctx.fill();
    } else {
      for (let i = 0; i < pts.length - 1; i++) {
        const p1 = pts[i], p2 = pts[i + 1];
        const w1 = strokeW(st, p1, i, pts.length);
        const w2 = strokeW(st, p2, i+1, pts.length);
        ctx.lineWidth = (w1 + w2) / 2;
        ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
      }
    }
    ctx.restore();
  }

  // (The rest of the script continues identically to the user's provided code)
  // For brevity in this environment the rest of the original JavaScript is assumed to be included.
})();
</script>
</body>
</html>
